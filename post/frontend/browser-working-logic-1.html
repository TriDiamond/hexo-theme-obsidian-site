
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>浏览器工作原理 — 之 HTTP 请求与解析 - 三钻 TriDiamond</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="浏览器工作原理是一块非常重要的内容，我们经常看到的 重绘 、重排 或者一些讲解 CSS 属性的时候，都会用到一些浏览器工作原理的知识来讲解。理论化学习浏览器工作原理，效果不是很大，而且很枯燥，所以这,"> 
    <meta name="author" content="三钻"> 
    <link rel="alternative" href="atom.xml" title="三钻 TriDiamond" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">

    
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">

    
<link rel="stylesheet" href="/css/obsidian.css">

    
<link rel="stylesheet" href="/css/ball-atom.min.css">

    
<meta name="generator" content="Hexo 5.4.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">三钻 TriDiamond</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="https://tridiamond.tech">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">浏览器工作原理 — 之 HTTP 请求与解析</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(https://img-blog.csdnimg.cn/20200815152729473.png) ">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="/categories/FrontEnd"><b>「
                    </b>FRONTEND<b> 」</b></a>
                
                八月 15, 2020
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/post/frontend/browser-working-logic-1.html" title="浏览器工作原理 — 之 HTTP 请求与解析" class="">浏览器工作原理 — 之 HTTP 请求与解析</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>文章字数</i>
                    113k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>阅读约需</i>
                    1:43
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>阅读次数</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list" itemprop="keywords"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/Browser/" rel="tag">Browser</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <p>浏览器工作原理是一块非常重要的内容，我们经常看到的 <code>重绘</code> 、<code>重排</code> 或者一些讲解 CSS 属性的时候，都会用到一些浏览器工作原理的知识来讲解。理论化学习浏览器工作原理，效果不是很大，而且很枯燥，所以这里我们从零开始用 <code>JavaScript</code> 来实现一个浏览器。</p>
<p>通过自己实现一遍简单的浏览器，我们会对浏览器的基本原理有更为深刻的理解。</p>
<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="浏览器基础渲染流程"><a href="#浏览器基础渲染流程" class="headerlink" title="浏览器基础渲染流程"></a>浏览器基础渲染流程</h1><p><img src="https://img-blog.csdnimg.cn/20200807200842150.png"></p>
<ul>
<li>首先浏览器是由 5 个步骤完成的整体渲染</li>
<li>我们从 URL 访问一个网页，经过浏览器的解析和渲染后成为了 Bitmap</li>
<li>最后通过我们的显卡驱动设配出去画面，让我们看到完成的页面</li>
<li>这是一个浏览器的渲染流程</li>
<li>这里我们只实现一个简单的基础流程，但是真正的浏览器还包含了很多功能，比如历史等等</li>
</ul>
<blockquote>
<p>我们主要需要完成的是从 URL 请求到 Bitmap 页面展示的整个流程就可以了。</p>
</blockquote>
<p>浏览器流程：</p>
<ol>
<li><code>URL</code> 部分，经过 <code>HTTP</code> 请求，然后解析返回内容，然后提取 <code>HTML</code> 内容</li>
<li>得到 <code>HTML</code> 后，我们可以通过文本分析（parse），然后把 HTML 的文本编程一个 <code>DOM</code> 树</li>
<li>这个时候的 <code>DOM</code> 树是光秃秃的，下一步我们进行 CSS 计算（CSS computing），最终把 CSS 挂载在这个 DOM 树上</li>
<li>经过计算后，我们就拥有一个有样式的 DOM 树，这个时候我们就可以布局（或者排版）了</li>
<li>通过布局计算，每一个 DOM 都会得到一个计算后的盒（当然实际浏览器中是每个 CSS 都会生成一个盒，但是为了简化这个，我们这里只做到每个 DOM 只生成一个盒即可）</li>
<li>最后我们就可以开始渲染（Render），把这个 DOM 树该有背景图的有背景图，该有背景色的有背景色，最后把这些样式画到一张图片上。然后我们可以通过操作系统和硬件驱动提供的 API 接口，展示出来给用户看了。</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="有限状态机去处理字符串"><a href="#有限状态机去处理字符串" class="headerlink" title="有限状态机去处理字符串"></a>有限状态机去处理字符串</h1><p>因为这个处理字符串是整个的浏览器里面贯穿使用的技巧，如果不会用这个状态机，后面实现和读浏览器实现的代码会非常吃力。所以这里我们先讲讲什么是有限状态机。</p>
<ul>
<li><strong>每一个状态都是一个机器</strong><ul>
<li>每个机器都是互相解耦，强有力的抽象机制</li>
<li>在每一个机器里，我们可以做计算、存储、输出等</li>
<li>所有的这些机器接受的输入是一致的</li>
<li>状态机的每一个机器本身没有状态，如果我们用函数来表达的话，它应该是纯函数（无副作用）</li>
<li>无副作用指的是：不应该再受外部的输入控制，输入是可以的</li>
</ul>
</li>
<li><strong>每一个机器知道下一个状态</strong><ul>
<li>每一个机器都有确定的下一个状态（Moore）</li>
<li>每一个机器根据输入决定下一个状态（Mealy）</li>
</ul>
</li>
</ul>
<h2 id="JavaScript-中如何实现"><a href="#JavaScript-中如何实现" class="headerlink" title="JavaScript 中如何实现"></a>JavaScript 中如何实现</h2><p>Mealy 状态机：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 每个函数是一个状态</span>
<span class="token keyword">function</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 函数参数就是输入</span>
  <span class="token comment">// 在函数中，可以自由地编写代码，处理每个状态的逻辑</span>
  <span class="token keyword">return</span> next <span class="token comment">// 返回值作为下一个状态</span>
<span class="token punctuation">}</span>

<span class="token comment">/** ========= 以下是调试 ========= */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取输入</span>
  state <span class="token operator">=</span> <span class="token function">state</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token comment">// 把状态机的返回值作为下一个状态</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>以上代码我们看到，每一个函数是一个状态</li>
<li>然后函数的参数是输入 <code>input</code></li>
<li>这个函数的返回值就是下一个状态，也就意味着下一个返回值一定得是一个状态函数</li>
<li>状态机理想的实现方式：一系列返回状态函数的一批状态函数</li>
<li>调用状态函数的时候，往往会用一个循环来获取输入，然后通过 <code>state = state(input)</code>，来让状态机接收输入来完成状态切换</li>
<li><code>Mealy</code> 型状态机，返回值一定是根据 <code>input</code> 返回下一个状态</li>
<li><code>Moore</code> 型状态机，返回值是与 <code>input</code> 没有任何关系，都是固定的状态返回</li>
</ul>
<h2 id="不使用状态机处理字符串"><a href="#不使用状态机处理字符串" class="headerlink" title="不使用状态机处理字符串"></a>不使用状态机处理字符串</h2><p>我们首先了解一下，在不使用状态机的情况下来实现一些字符串的处理方式：</p>
<p><strong>第一问题：在一个字符串中，找到字符“a”</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> letter <span class="token keyword">of</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'I am TriDiamond'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第二个问题：不准使用正则表达式，纯粹用 JavaScript 的逻辑实现：在一个字符串中，找到字符“ab”</strong></p>
<p>「直接寻找 <code>a</code> 和 <code>b</code>，都找到时返回」</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 直接寻找 `a` 和 `b`，都找到时返回
 * @param {*} string 被匹配的字符
 */</span>
<span class="token keyword">function</span> <span class="token function">matchAB</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hasA <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> letter <span class="token keyword">of</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hasA <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hasA <span class="token operator">&amp;&amp;</span> letter <span class="token operator">==</span> <span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      hasA <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">matchAB</span><span class="token punctuation">(</span><span class="token string">'hello abert'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第三个问题：不准使用正则表达式，纯粹用 JavaScript 的逻辑实现：在一个字符串中，找到字符“abcdef”</strong></p>
<p>方法一：「使用暂存空间，移动指针来检测」</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 使用暂存空间，移动指针来检测
 * @param {*} match 需要匹配的字符
 * @param {*} string 被匹配的字符
 */</span>
<span class="token keyword">function</span> <span class="token function">matchString</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> resultLetters <span class="token operator">=</span> match<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment">// 需要匹配的字符拆解成数组来记录</span>
  <span class="token keyword">const</span> stringArray <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment">// 把被匹配的字符串内容也拆解成数组</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 匹配字符串的指针</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> stringArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为要保证字符的绝对匹配，如 “ab” 不能是 "abc",不能是 "a b"</span>
    <span class="token comment">// 所以这里需要两个字符必须是有顺序的关系的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stringArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> resultLetters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果找到一个字符是吻合的，就 index + 1 找下一个字符</span>
      index<span class="token operator">++</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果下一个字符不吻合，就重置重新匹配</span>
      index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果已经匹配完所有的字符了，直接可以返回 true</span>
    <span class="token comment">// 证明字符中含有需要寻找的字符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> resultLetters<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'方法1'</span><span class="token punctuation">,</span> <span class="token function">matchString</span><span class="token punctuation">(</span><span class="token string">'abcdef'</span><span class="token punctuation">,</span> <span class="token string">'hello abert abcdef'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>方法二：「使用 <code>substring</code>和匹配字符的长度来截取字符，看是否等于答案」</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 通用字符串匹配 - 参考方法2（使用substring）
 * @param {*} match 需要匹配的字符
 * @param {*} string 被匹配的字符
 */</span>
<span class="token keyword">function</span> <span class="token function">matchWithSubstring</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> string<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> match<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">===</span> match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'方法2'</span><span class="token punctuation">,</span> <span class="token function">matchWithSubstring</span><span class="token punctuation">(</span><span class="token string">'abcdef'</span><span class="token punctuation">,</span> <span class="token string">'hello abert abcdef'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>方法三：「逐个查找，直到找到最终结果」</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 逐个查找，直到找到最终结果
 * @param {*} string 被匹配的字符
 */</span>
<span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> matchStatus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> matchLetters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> statusIndex <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> letter <span class="token keyword">of</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">==</span> matchLetters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      matchStatus<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
      statusIndex<span class="token operator">++</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      matchStatus<span class="token punctuation">[</span>statusIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      letter <span class="token operator">==</span> matchLetters<span class="token punctuation">[</span>statusIndex<span class="token punctuation">]</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      matchStatus<span class="token punctuation">[</span>statusIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
      statusIndex<span class="token operator">++</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      matchStatus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">]</span>
      statusIndex <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>statusIndex <span class="token operator">&gt;</span> matchLetters<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'方法3'</span><span class="token punctuation">,</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'hello abert abcdef'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用状态机处理字符"><a href="#使用状态机处理字符" class="headerlink" title="使用状态机处理字符"></a>使用状态机处理字符</h2><p>这里我们使用状态机的方式来实现：<strong>在一个字符串中，找到字符“abcdef”</strong></p>
<ul>
<li>首先每一个状态都是状态函数</li>
<li>我们应该有一个开始状态和结束状态函数，分别问题 <code>start</code> 和 <code>end</code></li>
<li>状态函数名字都代表当前状态的情况 <code>matchedA</code> 就是已经匹配中 <code>a</code> 字符了，以此类推</li>
<li>每一个状态中的逻辑就是匹配下一个字符</li>
<li>如果匹配成功返回下一个状态函数</li>
<li>如果匹配失败返回开始状态 <code>start</code></li>
<li>因为字符中最后一个是 <code>f</code> 字符，所以 <code>matchedE</code> 成功后，可以直接返回 结束状态<code>end</code></li>
<li><code>end</code> 这个结束状态，也被称为陷阱方法 (Trap)，因为状态转变结束了，所以让状态一直停留在这里，知道循环结束</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 状态机字符串匹配
 * @param {*} string
 */</span>
<span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> start

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> letter <span class="token keyword">of</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token function">state</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span> <span class="token comment">// 状态切换</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> state <span class="token operator">===</span> end <span class="token comment">// 如果最后的状态函数是 `end` 即返回 true</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedA
  <span class="token keyword">return</span> start
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> end
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedA</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedB
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedB</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'c'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedC
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedC</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'d'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedD
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedD</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'e'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedE
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedE</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'f'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">end</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'I am abcdef'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>问题升级：用状态机实现字符串“abcabx”的解析</strong></p>
<ul>
<li>这个问题与上面的区别在于”ab”有重复</li>
<li>所以我们分析的逻辑应该是：<ul>
<li>第一次 “b” 后面是 “c”，而第二次 “b” 后面就应该是 “x”</li>
<li>如果第二次的后面不是 “x” 的话就回到上一个判断状态函数</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 状态机匹配字符串
 * @param {*} string 被匹配的字符
 */</span>
<span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> start

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> letter <span class="token keyword">of</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token function">state</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> state <span class="token operator">===</span> end
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedA
  <span class="token keyword">return</span> start
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> end
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedA</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedB
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedB</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'c'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedC
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedC</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedA2
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedA2</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> matchedB2
  <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">matchedB2</span><span class="token punctuation">(</span><span class="token parameter">letter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>letter <span class="token operator">===</span> <span class="token string">'x'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> end
  <span class="token keyword">return</span> <span class="token function">matchedB</span><span class="token punctuation">(</span>letter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result: '</span><span class="token punctuation">,</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'abcabcabx'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="HTTP-协议解析基础知识"><a href="#HTTP-协议解析基础知识" class="headerlink" title="HTTP 协议解析基础知识"></a>HTTP 协议解析基础知识</h1><h2 id="ISO-OSI-七层网络模型"><a href="#ISO-OSI-七层网络模型" class="headerlink" title="ISO-OSI 七层网络模型"></a>ISO-OSI 七层网络模型</h2><p><strong>HTTP</strong></p>
<ul>
<li>组成：<ul>
<li>应用</li>
<li>表示</li>
<li>会话</li>
</ul>
</li>
<li>对应 node 的代码里，我们有熟悉的 <code>require('http')</code></li>
</ul>
<p><strong>TCP</strong></p>
<ul>
<li>组成：<ul>
<li>传输</li>
</ul>
</li>
<li>因为网页是需要可靠传输，所以我们只关心 TCP</li>
</ul>
<p><strong>Internet</strong></p>
<ul>
<li>组成：<ul>
<li>网络</li>
</ul>
</li>
<li>有时候讲上网有两层意思<ul>
<li>网页所在的应用层的协议（外网）—— 负责数据传输的是 Internet</li>
<li>公司内网，叫 Intranet</li>
</ul>
</li>
</ul>
<p><strong>4G/5G/Wi-Fi</strong></p>
<ul>
<li>组成：<ul>
<li>数据链路</li>
<li>物理层</li>
</ul>
</li>
<li>为了完成对数据准确的传输</li>
<li>传输都是点对点的传输</li>
<li>必须有直接的连接才能进行传输</li>
</ul>
<h3 id="TCP-与-IP-的基础知识"><a href="#TCP-与-IP-的基础知识" class="headerlink" title="TCP 与 IP 的基础知识"></a>TCP 与 IP 的基础知识</h3><ul>
<li>流<ul>
<li>TCP 层中传输数据的概念是 “流”</li>
<li>流是一种没有明显的分割单位</li>
<li>它只保证前后的顺序是正确的</li>
</ul>
</li>
<li>端口<ul>
<li>TCP 协议是被计算机里面的软件所使用的</li>
<li>每一个软件都会去从网卡去拿数据</li>
<li>端口决定哪一个数据分配给哪一个软件</li>
<li>对应 node.js 的话就是应用 <code>require('net')</code></li>
</ul>
</li>
<li>包<ul>
<li>TCP 的传输概念就是一个一个的数据包</li>
<li>每一个数据包可大可小</li>
<li>这个取决于你整个的网络中间设备的传输能力</li>
</ul>
</li>
<li>IP 地址<ul>
<li>IP 根据地址去找到数据包应该从哪里到哪里</li>
<li>在 Internet 上的连接关系非常复杂，中间就会有一些大型的路由节点</li>
<li>当我们访问一个 IP 地址时，就会连接上我们的小区地址上，然后到电信的主干</li>
<li>如果是访问外国的话，就会再上到国际的主干地址上</li>
<li>这个 IP 地址是唯一的标识，连入 Internet 上的每一个设备</li>
<li>所以 IP 包，就是通过 IP 地址找到自己需要被传输到哪里</li>
</ul>
</li>
<li>libnet/libpcap<ul>
<li>IP 协议需要调用到 C++ 的这两个库</li>
<li>libnet 负责构造 IP 包并且发送</li>
<li>labpcap 负责从网卡抓取所有流经网卡的 IP 包</li>
<li>如果我们去用交换机而不是路由器去组网，我们用底层的 labpcap 包就能抓到很多本来不属于发给我们的 IP 包</li>
</ul>
</li>
</ul>
<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><ul>
<li>组成<ul>
<li>Request 请求</li>
<li>Response 返回</li>
</ul>
</li>
<li>相对于 TCP 这种全双工通道，就是可以发也可以收，没有优先关系</li>
<li>而 HTTP 特别的是必须得先由客户端发起一个 request</li>
<li>然后服务端回来一个 response</li>
<li>所以每一个 request 必定有一个对应的 response</li>
<li>如果 request 或者 response 多了都说明协议出错</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="HTTP-请求-——-服务端环境准备"><a href="#HTTP-请求-——-服务端环境准备" class="headerlink" title="HTTP 请求 —— 服务端环境准备"></a>HTTP 请求 —— 服务端环境准备</h1><p>在我们编写自己的浏览器之前，我们首先建立一个 node.js 服务端。</p>
<p>首先我们编写一个 <code>node.js</code> 的服务端：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

http
  <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    request
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        body<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span>
        response<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">' Hello World\n'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server started'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="了解-HTTP-Request-协议"><a href="#了解-HTTP-Request-协议" class="headerlink" title="了解 HTTP Request 协议"></a>了解 HTTP Request 协议</h2><p>在编写我们的客户端代码之前，我们需要先了解一下 HTTP 协议。</p>
<p>我们先来看看 HTTP 协议的 request 部分：</p>
<blockquote>
<p>POST / HTTP/1.1</p>
<p>Host: 127.0.0.1</p>
<p>Content-Type: application/x-www-form-urlencoded</p>
<p>field1=aaa&amp;code=x%3D1</p>
</blockquote>
<ul>
<li>HTTP 协议是一个文本型的协议，文本型的协议一般来说与二进制的协议是相对的，也意味着这个协议里面所有内容都是字符串，每一个字节都是字符串的一部分。</li>
<li>HTTP 协议的第一行叫做 <code>request line</code>，包含了三个部分：<ul>
<li>Method：例如 POST，GET 等</li>
<li>Path：默认就是 “/”</li>
<li>HTTP 和 HTTP 版本：HTTP/1.1</li>
</ul>
</li>
<li>然后接下来就是 <code>Headers</code><ul>
<li>Header 的行数不固定</li>
<li>每一行都是以一个冒号分割了 <code>key: value</code> 格式</li>
<li>Headers 是以空行进行结束</li>
</ul>
</li>
<li>最后的一部分就是 <code>body</code> 部分：<ul>
<li>这个部分的内容是以 <code>Content-Type</code>来决定的</li>
<li>Content-Type 规定了什么格式，那么 body 就用什么格式来写</li>
</ul>
</li>
</ul>
<p>接下来我们就可以开始编写代码了！</p>
<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="实现-HTTP-请求"><a href="#实现-HTTP-请求" class="headerlink" title="实现 HTTP 请求"></a>实现 HTTP 请求</h1><ul>
<li>设计一个 HTTP 请求的类</li>
<li>content type 是一个必要的字段，要有默认值</li>
<li>body 是 KV 格式</li>
<li>不同的 content-type 影响 body 的格式</li>
</ul>
<h2 id="Request-类"><a href="#Request-类" class="headerlink" title="Request 类"></a>Request 类</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Request</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首先在 constructor 赋予需要使用的默认值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> options<span class="token punctuation">.</span>method <span class="token operator">||</span> <span class="token string">'GET'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> options<span class="token punctuation">.</span>host
    <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> options<span class="token punctuation">.</span>port <span class="token operator">||</span> <span class="token number">80</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> options<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> options<span class="token punctuation">.</span>body <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> options<span class="token punctuation">.</span>headers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'application/x-www-form-urlencoded'</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据 Content-Type 转换 body 的格式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>bodyText <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'application/x-www-form-urlencoded'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>bodyText <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>body<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 自动计算 body 内容长度，如果长度不对，就会是一个非法请求</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Length'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bodyText<span class="token punctuation">.</span>length
  <span class="token punctuation">}</span>
  <span class="token comment">// 发送请求的方法，返回 Promise 对象</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//......</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 请求方法
 */</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token string">'8080'</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span><span class="token string">'X-Foo2'</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'custom'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'tridiamond'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="Request-类中的-send-函数编写"><a href="#Request-类中的-send-函数编写" class="headerlink" title="Request 类中的 send 函数编写"></a>Request 类中的 send 函数编写</h1><ul>
<li>Send 函数是一个 Promise 的形式</li>
<li>所以在 send 的过程中会逐步收到 response</li>
<li>最后把 response 构造好之后再让 Promise 得到 resolve</li>
<li>因为过程是逐步收到信息的，我们需要设计一个 ResponseParse</li>
<li>这样 Parse 可以通过逐步地去接收 response 的信息来构造 response 对象不同的部分</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 发送请求的方法，返回 Promise 对象</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="设计-ResponseParser"><a href="#设计-ResponseParser" class="headerlink" title="设计 ResponseParser"></a>设计 ResponseParser</h2><ul>
<li>Receive 函数接收字符串</li>
<li>然后用状态机对逐个字符串进行处理</li>
<li>所以我们需要循环每个字符串，然后加入 <code>recieveChar</code> 函数来对每个字符进行处理</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ResponseParser</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> string<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">receiveChar</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">receiveChar</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="了解-HTTP-Response-协议"><a href="#了解-HTTP-Response-协议" class="headerlink" title="了解 HTTP Response 协议"></a>了解 HTTP Response 协议</h2><p>在接下来的部分，我们需要在代码中解析 HTTP Response 中的内容，所以我先来了解一下 HTTP Response 中的内容。</p>
<blockquote>
<p>HTTP/1.1 200 OK</p>
<p>Content-Type: text/html</p>
<p>Date: Mon, 23 Dec 2019 06:46:19 GMT</p>
<p>Connection: keep-alive</p>
<p>Transfer-Encoding: chunked</p>
<p>26</p>
<html><body> Hello World <body></body></body></html>

<p>0</p>
</blockquote>
<ul>
<li>首先第一行的 <code>status line</code> 与 request line 相反<ul>
<li>第一部分是 HTTP 协议的版本：HTTP/1.1</li>
<li>第二部分是 HTTP 状态码：200 (在实现我们的浏览器，为了更加简单一点，我们可以把 200 以外的状态为出错)</li>
<li>第三部分是 HTTP 状态文本：OK</li>
</ul>
</li>
<li>随后的部分就是 header 部分<ul>
<li>HTML 的 request 和 response 都是包含 header 的</li>
<li>它的格式跟 request 是完全一致的</li>
<li>最后是一个空行，用来分割 headers 和 body 内容的部分的</li>
</ul>
</li>
<li>最后这里的就是 body 部分了<ul>
<li>这里 body 的格式也是根据 Content-Type 来决定的</li>
<li>这里有一种比较典型的格式叫做 <code>chunked body</code> (是 Node 默认返回的一种格式)</li>
<li>Chunked body 是由一个十六进制的数字单独占一行</li>
<li>后面跟着内容部分</li>
<li>最后跟着一个十六进制的 0，0 之后就是整个 body 的结尾了</li>
<li>这个也是用来分割 body 的内容</li>
</ul>
</li>
</ul>
<h2 id="实现发送请求"><a href="#实现发送请求" class="headerlink" title="实现发送请求"></a>实现发送请求</h2><p>这里我们开始实战，通过实现 send 函数中的逻辑来真正发送请求到服务端。</p>
<ul>
<li>设计支持已有的 connection 或者自己新增 connection</li>
<li>收到数据传给 parser</li>
<li>根据 parser 的状态 resolve Promise</li>
</ul>
<p>通过以上思路，我们来实现代码：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 发送请求的方法，返回 Promise 对象</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 先判断 connection 是否有传送过来</span>
      <span class="token comment">// 没有就根据，Host 和 port 来创建一个 TCP 连接</span>
      <span class="token comment">// `toString` 是把请求参数按照 HTTP Request 的格式组装</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        connection <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span>
            host<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token punctuation">,</span>
            port<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            connection<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 监听 connection 的 data</span>
      <span class="token comment">// 然后原封不动传给 parser</span>
      <span class="token comment">// 如果 parser 已经结束的话，我们就可以进行 resolve</span>
      <span class="token comment">// 最后断开连接</span>
      connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        parser<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span>isFinished<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 监听 connection 的 error</span>
      <span class="token comment">// 如果请求出现错误，首先 reject 这个promise</span>
      <span class="token comment">// 然后断开连接，避免占着连接的情况</span>
      connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 组装 HTTP Request 文本内容
   */</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> HTTP/1.1\r
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\r\n'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\r\r
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>bodyText<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="实现-RequestParser-类"><a href="#实现-RequestParser-类" class="headerlink" title="实现 RequestParser 类"></a>实现 RequestParser 类</h1><p>现在我们来具体实现 RequestParser 类的代码。</p>
<ul>
<li>Response 必须分段构造，所以我们要用一个 Response Parser 来 “装配”</li>
<li>ResponseParser 分段处理 Response Text，我们用状态机来分析文本结构</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * Response 解析器
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ResponseParser</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLine
    <span class="token keyword">this</span><span class="token punctuation">.</span>statusLine <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerName <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bodyParser <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> string<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">receiveEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> receiveEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待状态行内容
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingStatusLine</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLineEnd
    <span class="token keyword">this</span><span class="token punctuation">.</span>statusLine <span class="token operator">+=</span> char
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLine
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待状态行结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingStatusLineEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderName
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLineEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 名
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderName</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">':'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderSpace
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderBlockEnd
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerName <span class="token operator">+=</span> char
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderName
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 空格
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderSpace</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">' '</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderValue
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderSpace
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 值
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderValue</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue
      <span class="token keyword">this</span><span class="token punctuation">.</span>headerName <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderLineEnd
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue <span class="token operator">+=</span> char
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderValue
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 行结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderLineEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderName
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderLineEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 内容结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderBlockEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingBody
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderBlockEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 body 内容
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingBody</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingBody
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="实现-Body-内容解析器"><a href="#实现-Body-内容解析器" class="headerlink" title="实现 Body 内容解析器"></a>实现 Body 内容解析器</h1><p>最后我们来实现 Body 内容的解析逻辑。</p>
<ul>
<li>Response 的 body 可能根据 Content-Type 有不同的结构，因此我们会采用子 Parser 的结构来解决问题</li>
<li>以 ChunkedBodyParser 为例，我们同样用状态机来处理 body 的格式</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * Response 解析器
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ResponseParser</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLine
    <span class="token keyword">this</span><span class="token punctuation">.</span>statusLine <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerName <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bodyParser <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bodyParser <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bodyParser<span class="token punctuation">.</span>isFinished
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>statusLine<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">HTTP\/1.1 ([0-9]+) ([\s\S]+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      statusCode<span class="token operator">:</span> RegExp<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">,</span>
      statusText<span class="token operator">:</span> RegExp<span class="token punctuation">.</span>$<span class="token number">2</span><span class="token punctuation">,</span>
      headers<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
      body<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bodyParser<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> string<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">receiveEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> receiveEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待状态行内容
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingStatusLine</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLineEnd
    <span class="token keyword">this</span><span class="token punctuation">.</span>statusLine <span class="token operator">+=</span> char
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLine
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待状态行结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingStatusLineEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderName
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingStatusLineEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 名
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderName</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">':'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderSpace
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Transfer-Encoding'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'chunked'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bodyParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkedBodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderBlockEnd
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerName <span class="token operator">+=</span> char
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderName
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 空格
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderSpace</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">' '</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderValue
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderSpace
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 值
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderValue</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue
      <span class="token keyword">this</span><span class="token punctuation">.</span>headerName <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderLineEnd
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerValue <span class="token operator">+=</span> char
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderValue
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 行结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderLineEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderName
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderLineEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Header 内容结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingHeaderBlockEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingBody
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingHeaderBlockEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 body 内容
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingBody</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bodyParser<span class="token punctuation">.</span><span class="token function">receiveChar</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingBody
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Chunked Body 解析器
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ChunkedBodyParser</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingLength
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isFinished <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token function">receiveChar</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Body 长度
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingLength</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isFinished <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingLengthLineEnd
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 转换十六进制长度</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">*=</span> <span class="token number">16</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">+=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingLength
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待 Body line 结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingLengthLineEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readingTrunk
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingLengthLineEnd
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 读取 Trunk 内容
   * @param {*} char 文本
   */</span>
  <span class="token function">readingTrunk</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">--</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingNewLine
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readingTrunk
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待新的一行
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingNewLine</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\r'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingNewLineEnd
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingNewLine
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 等待新的一行结束
   * @param {*} char 文本
   */</span>
  <span class="token function">waitingNewLineEnd</span><span class="token punctuation">(</span><span class="token parameter">char</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingLength
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waitingNewLineEnd
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><blockquote>
<p>我是<font color="#60AAF8"><b>三钻</b></font>，一个在<font color="#60AAF8"><b>《技术银河》</b></font>中等你们一起来终生漂泊学习。</p>
<p>点赞是力量，关注是认可，评论是关爱！下期再见 👋！</p>
</blockquote>
<p>这里我们就实现了浏览器的 HTTP Request 请求，HTTP Response 解析的过程的代码。</p>
<p>下一篇文我们来一起实现 HTTP 解析并且构建 DOM 树，然后进行 CSS 计算。</p>
<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<h1 id="推荐专栏"><a href="#推荐专栏" class="headerlink" title="推荐专栏"></a>推荐专栏</h1><p>小伙伴们可以<strong>查看或者订阅相关的专栏</strong>，从而集中阅读相关知识的文章哦。</p>
<ul>
<li><p>📖 <a target="_blank" rel="noopener" href="https://blog.csdn.net/tridiamond6/category_10036942.html">《数据结构与算法》</a> — 到了如今，如果想成为一个高级开发工程师或者进入大厂，不论岗位是前端、后端还是 AI，算法都是重中之重。也无论我们需要进入的公司的岗位是否最后是做算法工程师，前提面试就需要考算法。</p>
</li>
<li><p>📖 <a target="_blank" rel="noopener" href="https://blog.csdn.net/tridiamond6/category_9782493.html">《FCC 前端集训营》</a> — 根据 FreeCodeCamp 的学习课程，一起深入浅出学习前端。稳固前端知识，一起在 FreeCodeCamp 获得证书</p>
</li>
<li><p>📖 <a target="_blank" rel="noopener" href="https://blog.csdn.net/tridiamond6/category_9782493.html">《前端星球》</a> — 以实战为线索，深入浅出前端多维度的知识点。内含有多方面的前端知识文章，带领不懂前端的童鞋一起学习前端，在前端开发路上童鞋一起燃起心中那团火 🔥</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20200613135642518.png"></p>
<p><img src="https://img-blog.csdnimg.cn/20200815153142398.png"></p>
<p><img src="https://img-blog.csdnimg.cn/20200620093918128.png"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/statics/chengdu.mp3'></li>
                
                    
            </ul>
            
            
            <div class="post-nav">
                <hr>
                
                
                    <div class="post-nav-item">下一篇:<a href="/post/frontend/frontend-study.html" rel="next" 
                        title="一篇文章搞懂前端学习方法与构建知识体系">一篇文章搞懂前端学习方法与构建知识体系</a></div>
                                
            </div>   
                        
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >留言</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://res.cloudinary.com/tridiamond/image/upload/v1573019751/TriDiamond_logo_ui_xeublz.jpg" height=300 width=300></img>
                    <p>三钻</p>
                    <span>Think like an artist, develop like an artisan</span>
                    <dl>
                        <dd><a href="https://github.com/TriDiamond" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://twitter.com/TriDiamond6" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/7602324/tridiamond?tab=profile" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">32 <p>文章</p></a></li>
                    <li><a href="/categories">13 <p>分类</p></a></li>
                    <li><a href="/tags">42 <p>标签</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>目录</h4>
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9F%BA%E7%A1%80%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">浏览器基础渲染流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E5%8E%BB%E5%A4%84%E7%90%86%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">2.</span> <span class="toc-text">有限状态机去处理字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript-%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.1.</span> <span class="toc-text">JavaScript 中如何实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81%E6%9C%BA%E5%A4%84%E7%90%86%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">2.2.</span> <span class="toc-text">不使用状态机处理字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%80%81%E6%9C%BA%E5%A4%84%E7%90%86%E5%AD%97%E7%AC%A6"><span class="toc-number">2.3.</span> <span class="toc-text">使用状态机处理字符</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP-%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">HTTP 协议解析基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ISO-OSI-%E4%B8%83%E5%B1%82%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.1.</span> <span class="toc-text">ISO-OSI 七层网络模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP-%E4%B8%8E-IP-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">3.1.1.</span> <span class="toc-text">TCP 与 IP 的基础知识</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP"><span class="toc-number">3.2.</span> <span class="toc-text">HTTP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP-%E8%AF%B7%E6%B1%82-%E2%80%94%E2%80%94-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">4.</span> <span class="toc-text">HTTP 请求 —— 服务端环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3-HTTP-Request-%E5%8D%8F%E8%AE%AE"><span class="toc-number">4.1.</span> <span class="toc-text">了解 HTTP Request 协议</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-HTTP-%E8%AF%B7%E6%B1%82"><span class="toc-number">5.</span> <span class="toc-text">实现 HTTP 请求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Request-%E7%B1%BB"><span class="toc-number">5.1.</span> <span class="toc-text">Request 类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">请求方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Request-%E7%B1%BB%E4%B8%AD%E7%9A%84-send-%E5%87%BD%E6%95%B0%E7%BC%96%E5%86%99"><span class="toc-number">6.</span> <span class="toc-text">Request 类中的 send 函数编写</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1-ResponseParser"><span class="toc-number">6.1.</span> <span class="toc-text">设计 ResponseParser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3-HTTP-Response-%E5%8D%8F%E8%AE%AE"><span class="toc-number">6.2.</span> <span class="toc-text">了解 HTTP Response 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-number">6.3.</span> <span class="toc-text">实现发送请求</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-RequestParser-%E7%B1%BB"><span class="toc-number">7.</span> <span class="toc-text">实现 RequestParser 类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Body-%E5%86%85%E5%AE%B9%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">实现 Body 内容解析器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">9.</span> <span class="toc-text">最后</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E4%B8%93%E6%A0%8F"><span class="toc-number">10.</span> <span class="toc-text">推荐专栏</span></a></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2021
        <span class="gradient-text">
            三钻
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.5" target="_blank" rel="noopener">v1.4.5</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>


 
<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
 
<script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
  
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/obsidian.js"></script>
<script src="/js/jquery.truncate.js"></script>
<script src="/js/search.js"></script>
 
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
 
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
 
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>


<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>
 
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>
  
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>
   
<script src="/js/busuanzi.min.js"></script>

<script>
  $(document).ready(function () {
    if ($('span[id^="busuanzi_"]').length) {
      initialBusuanzi();
    }
  });
</script>
 
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">


<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'UA-149874671-1');
</script>
 

<script>
  function initialTyped() {
    var typedTextEl = $('.typed-text');
    if (typedTextEl && typedTextEl.length > 0) {
      var typed = new Typed('.typed-text', {
        strings: ['Think like an artist, develop like an artisan', '艺术家思维去思考问题，工匠创造精神去开发'],
        typeSpeed: 90,
        loop: true,
        loopCount: Infinity,
        backSpeed: 20,
      });
    }
  }

  if ($('.article-header') && $('.article-header').length) {
    $(document).ready(function () {
      initialTyped();
    });
  }
</script>




 <!-- 例：百度统计 --> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?your_code"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> 

</html>
